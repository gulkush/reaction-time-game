<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reaction Time</title>
  <style>
    :root {
      --bg: #0b0b0b;
      --fg: #f5f5f5;
      --accent: #39d353;
      --warn: #ff5c5c;
      --muted: #a8a8a8;
      --card: rgba(255, 255, 255, 0.06);
      --shadow: 0 20px 60px rgba(0, 0, 0, 0.45);
      --panel: rgba(255, 255, 255, 0.08);
      --outline: rgba(255, 255, 255, 0.12);
    }

    * { box-sizing: border-box; }

    html, body { height: 100%; }

    body {
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", sans-serif;
      color: var(--fg);
      background: radial-gradient(1200px 800px at 70% -10%, #222 0%, #0b0b0b 50%, #050505 100%);
      display: grid;
      align-content: start;
      justify-items: center;
      padding: 24px 0 48px;
      overflow-y: auto;
      overflow-x: hidden;
      -webkit-tap-highlight-color: transparent;
    }

    .app {
      width: min(94vw, 720px);
      min-height: 72vh;
      padding: 24px;
      margin: 24px 0;
      border-radius: 20px;
      background: var(--card);
      box-shadow: var(--shadow);
      display: grid;
      gap: 16px;
      align-content: start;
      text-align: center;
      backdrop-filter: blur(10px);
      position: relative;
      z-index: 2;
      max-height: none;
      overflow: visible;
    }

    h1 {
      margin: 0;
      font-size: 1.6rem;
      letter-spacing: 0.02em;
    }

    .status {
      font-size: 1.1rem;
      line-height: 1.4;
    }

    .timer {
      font-size: 2.4rem;
      font-weight: 700;
      letter-spacing: 0.02em;
    }

    .tap-area {
      width: 100%;
      height: min(180px, 36vw);
      margin: 8px auto;
      border-radius: 26px;
      border: 2px dashed var(--outline);
      display: grid;
      place-items: center;
      background: rgba(0, 0, 0, 0.3);
      cursor: pointer;
      user-select: none;
      transition: transform 0.12s ease, border-color 0.12s ease;
    }

    .tap-area.ready { background: rgba(0, 0, 0, 0.3); }
    .tap-area.wait { background: #111; }
    .tap-area.go { background: var(--accent); color: #0b0b0b; }
    .tap-area.false { background: var(--warn); color: #0b0b0b; }

    .tap-area:active {
      transform: scale(0.98);
      border-color: var(--accent);
    }

    .tap-label {
      font-size: 1rem;
      color: var(--muted);
    }

    .hint {
      color: var(--muted);
      font-size: 0.95rem;
    }

    .controls {
      display: grid;
      grid-auto-flow: column;
      gap: 12px;
      justify-content: center;
      flex-wrap: wrap;
    }

    button {
      appearance: none;
      border: 1px solid transparent;
      background: #1a1a1a;
      color: var(--fg);
      padding: 10px 16px;
      border-radius: 999px;
      font-size: 0.95rem;
      cursor: pointer;
    }

    button:focus-visible {
      outline: 2px solid #fff;
      outline-offset: 2px;
    }

    button.secondary {
      background: transparent;
      border-color: var(--outline);
      color: var(--fg);
    }

    button.primary-yellow {
      background: #f4c430;
      color: #1a1a1a;
      border-color: transparent;
      font-weight: 700;
    }

    button[disabled] {
      opacity: 0.55;
      cursor: not-allowed;
    }

    .lobby {
      display: grid;
      gap: 12px;
      padding: 14px;
      margin-top: 30px;
      border-radius: 14px;
      background: var(--panel);
      border: 1px solid var(--outline);
      text-align: left;
    }

    .lobby-row {
      display: grid;
      gap: 10px;
      align-items: center;
    }

    .lobby-row.two {
      grid-template-columns: 1fr auto;
    }

    .lobby-row.three {
      grid-template-columns: 1fr 1fr auto;
    }

    label {
      font-size: 0.85rem;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    input[type="text"] {
      width: 100%;
      border-radius: 12px;
      border: 1px solid var(--outline);
      background: rgba(0, 0, 0, 0.4);
      color: var(--fg);
      padding: 10px 12px;
      font-size: 0.95rem;
    }

    .link-box {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items: center;
      background: rgba(0, 0, 0, 0.35);
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px dashed var(--outline);
      font-size: 0.9rem;
      color: var(--muted);
      word-break: break-all;
    }

    .grid-wrap {
      display: grid;
      gap: 8px;
      padding-bottom: 6px;
      width: 100%;
      max-width: 100%;
      overflow: hidden;
    }

    .grid {
      display: grid;
      grid-template-columns: minmax(120px, 1.2fr) repeat(5, minmax(64px, 1fr));
      min-width: 0;
      width: 100%;
      gap: 6px;
      text-align: center;
      font-size: 0.9rem;
    }

    .grid .cell {
      background: rgba(0, 0, 0, 0.35);
      border: 1px solid var(--outline);
      border-radius: 10px;
      padding: 8px 6px;
      min-height: 36px;
      display: grid;
      place-items: center;
    }

    .grid .cell.best {
      background: var(--fg);
      color: #0b0b0b;
      border-color: transparent;
      font-weight: 700;
    }

    .grid .cell.winner {
      animation: winnerGlow 1.1s infinite;
      box-shadow: 0 0 16px rgba(57, 211, 83, 0.9), 0 0 30px rgba(57, 211, 83, 0.6);
      border-color: transparent;
    }

    .winner-banner {
      display: none;
      padding: 10px 14px;
      border-radius: 999px;
      background: rgba(57, 211, 83, 0.2);
      border: 1px solid rgba(57, 211, 83, 0.6);
      color: var(--fg);
      font-weight: 700;
      letter-spacing: 0.04em;
      text-align: center;
    }

    .winner-banner.show {
      display: inline-grid;
      place-items: center;
    }

    @keyframes winnerGlow {
      0% {
        background: #39d353;
        color: #0b0b0b;
        box-shadow: 0 0 6px rgba(57, 211, 83, 0.6), 0 0 14px rgba(57, 211, 83, 0.4);
      }
      50% {
        background: #00e5ff;
        color: #041316;
        box-shadow: 0 0 10px rgba(0, 229, 255, 0.7), 0 0 24px rgba(0, 229, 255, 0.6);
      }
      100% {
        background: #ff57d8;
        color: #1a0010;
        box-shadow: 0 0 10px rgba(255, 87, 216, 0.7), 0 0 24px rgba(255, 87, 216, 0.6);
      }
    }

    .grid .header {
      background: rgba(255, 255, 255, 0.08);
      color: var(--muted);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 0.72rem;
    }

    .grid .name {
      justify-content: start;
      text-align: left;
      padding-left: 10px;
      font-weight: 600;
    }

    .attempts {
      font-size: 0.9rem;
      color: var(--muted);
    }

    @media (max-width: 720px) {
      .controls {
        grid-auto-flow: row;
      }

      .lobby-row.three,
      .lobby-row.two {
        grid-template-columns: 1fr;
      }

      .grid {
        grid-template-columns: minmax(110px, 1fr) repeat(5, minmax(52px, 1fr));
      }
    }

    @media (max-width: 480px) {
      body {
        padding: 16px 0 24px;
      }

      .app {
        width: min(96vw, 480px);
        padding: 16px;
        gap: 12px;
        margin: 24px 0;
        max-height: none;
      }

      h1 {
        font-size: 1.3rem;
      }

      .status {
        font-size: 1rem;
      }

      .timer {
        font-size: 2rem;
      }

      .tap-area {
        height: 140px;
        border-radius: 18px;
      }

      .lobby {
        padding: 12px;
        gap: 10px;
      }

      .controls {
        gap: 8px;
      }

      #soundBtn,
      #shareBtn {
        display: none;
      }

      .grid {
        grid-template-columns: minmax(90px, 1fr) repeat(5, minmax(44px, 1fr));
        font-size: 0.78rem;
      }
    }

    .screen {
      position: fixed;
      inset: 0;
      background: var(--bg);
      transition: background 0.12s ease;
      display: grid;
      place-items: center;
      z-index: -1;
    }

    .screen.ready { background: #0b0b0b; }
    .screen.wait { background: #111; }
    .screen.go { background: var(--accent); }
    .screen.false { background: var(--warn); }


    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      border: 0;
    }
  </style>
</head>
<body>
  <div class="screen ready" id="screen" aria-hidden="true"></div>

  <main class="app" role="main">
    <h1>Reaction Time</h1>
    <section class="lobby" aria-label="Challenge lobby">
      <div class="lobby-row three">
        <div>
          <label for="playerName">Player name</label>
          <input id="playerName" type="text" maxlength="18" placeholder="Enter your name" />
        </div>
        <div>
          <label>Players</label>
          <div class="attempts" id="playerCount">0 / 5</div>
        </div>
        <div class="controls">
          <button id="challengeBtn" type="button" class="primary-yellow">Challenge Friends</button>
          <button id="joinBtn" type="button" class="secondary" hidden>Join Challenge</button>
          <button id="exitBtn" type="button" class="secondary" hidden>Exit Challenge</button>
        </div>
      </div>
      <div class="lobby-row two">
        <div>
          <label>Challenge link</label>
          <div class="link-box" id="linkBox">Create a challenge to get a link.</div>
        </div>
        <div class="controls">
          <button id="copyBtn" type="button" class="secondary" disabled>Copy Link</button>
        </div>
      </div>
    </section>
    <div class="status" id="status">Tap anywhere to start.</div>
    <div class="timer" id="timer">—</div>
    <div class="tap-area" id="tapArea" role="button" tabindex="0" aria-label="Tap area">
      <div class="tap-label" id="tapLabel">Tap Here</div>
    </div>
    <div class="attempts" id="attemptsInfo">Attempts left: 5</div>
    <div class="hint" id="hint">Wait for green, then tap as fast as you can.</div>
    <div class="controls">
      <button id="restartBtn" type="button" hidden>Restart</button>
      <button id="soundBtn" type="button" aria-pressed="false">Sound: Off</button>
      <button id="shareBtn" type="button" disabled>Share Result</button>
    </div>
    <div class="winner-banner" id="winnerBanner">Winner: —</div>
    <section class="grid-wrap" aria-label="Challenge leaderboard" hidden>
      <div class="grid" id="grid"></div>
    </section>
    <div class="sr-only" id="srStatus" aria-live="polite"></div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      set,
      get,
      onValue,
      runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const screen = document.getElementById('screen');
    const statusEl = document.getElementById('status');
    const timerEl = document.getElementById('timer');
    const hintEl = document.getElementById('hint');
    const restartBtn = document.getElementById('restartBtn');
    const soundBtn = document.getElementById('soundBtn');
    const shareBtn = document.getElementById('shareBtn');
    const srStatus = document.getElementById('srStatus');
    const playerNameInput = document.getElementById('playerName');
    const joinBtn = document.getElementById('joinBtn');
    const exitBtn = document.getElementById('exitBtn');
    const challengeBtn = document.getElementById('challengeBtn');
    const copyBtn = document.getElementById('copyBtn');
    const linkBox = document.getElementById('linkBox');
    const playerCountEl = document.getElementById('playerCount');
    const attemptsInfo = document.getElementById('attemptsInfo');
    const gridEl = document.getElementById('grid');
    const tapArea = document.getElementById('tapArea');
    const tapLabel = document.getElementById('tapLabel');
    const winnerBanner = document.getElementById('winnerBanner');

    const State = {
      IDLE: 'idle',
      WAITING: 'waiting',
      GO: 'go',
      RESULT: 'result',
      FALSE: 'false'
    };

    let state = State.IDLE;
    let startTime = 0;
    let timeoutId = null;
    let soundOn = false;
    let lastReaction = null;
    let bestReaction = null;
    let challengeId = null;
    let playerId = null;
    let playerName = '';
    let isJoined = false;
    let attemptsLeft = 5;
    let localAttempts = 0;
    let localAttemptValues = [];
    let currentPlayers = {};

    const firebaseConfig = {
      apiKey: "AIzaSyCrZb-G8Cvk2mUDFWabC4FrWszCUK47xaw",
      authDomain: "connect4-e2ad8.firebaseapp.com",
      databaseUrl: "https://connect4-e2ad8-default-rtdb.firebaseio.com",
      projectId: "connect4-e2ad8",
      storageBucket: "connect4-e2ad8.firebasestorage.app",
      messagingSenderId: "763431725125",
      appId: "1:763431725125:web:956d260fb6a2eccd471b2c",
      measurementId: "G-HSS2LVPCSY"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const setState = (next) => {
      state = next;
      const nextClass = next === State.GO ? 'go' : next === State.FALSE ? 'false' : next === State.WAITING ? 'wait' : 'ready';
      screen.className = 'screen ready';
      tapArea.className = `tap-area ${nextClass}`;
    };

    const setStatus = (text) => {
      statusEl.textContent = text;
      srStatus.textContent = text;
    };

    const beep = (freq = 520, duration = 100) => {
      if (!soundOn) return;
      const ctx = new (window.AudioContext || window.webkitAudioContext)();
      const osc = ctx.createOscillator();
      const gain = ctx.createGain();
      osc.frequency.value = freq;
      osc.type = 'sine';
      gain.gain.value = 0.08;
      osc.connect(gain);
      gain.connect(ctx.destination);
      osc.start();
      setTimeout(() => {
        osc.stop();
        ctx.close();
      }, duration);
    };

    const reset = () => {
      clearTimeout(timeoutId);
      timeoutId = null;
      startTime = 0;
      timerEl.textContent = '—';
      hintEl.textContent = 'Wait for green, then tap as fast as you can.';
      if (!challengeId) {
        setStatus('Tap the center box to start.');
        localAttempts = 0;
        localAttemptValues = [];
        updateAttemptsInfo(0);
        renderGrid();
      } else {
        setStatus(isJoined ? 'Tap the center box to start.' : 'Join a challenge to start.');
      }
      shareBtn.disabled = true;
      lastReaction = null;
      setState(State.IDLE);
      tapLabel.textContent = 'Tap Here';
    };

    const start = () => {
      if (challengeId && !isJoined) {
        setStatus('Join the challenge first.');
        return;
      }
      if (attemptsLeft <= 0) {
        setStatus('No attempts left.');
        return;
      }
      if (state !== State.IDLE && state !== State.RESULT && state !== State.FALSE) return;
      setState(State.WAITING);
      setStatus('Get ready...');
      hintEl.textContent = 'Don\'t tap until the screen turns green.';
      const delay = 2000 + Math.random() * 3000;
      timeoutId = setTimeout(() => {
      setState(State.GO);
      setStatus('Tap now!');
      hintEl.textContent = 'Go!';
      startTime = performance.now();
      beep(720, 90);
      tapLabel.textContent = 'Tap Now!';
    }, delay);
    };

    const registerAttempt = (value) => {
      if (challengeId) {
        saveAttempt(value);
        attemptsLeft = Math.max(0, attemptsLeft - 1);
        attemptsInfo.textContent = `Attempts left: ${attemptsLeft}`;
      } else {
        localAttempts = Math.min(5, localAttempts + 1);
        if (localAttemptValues.length < 5) {
          localAttemptValues.push(value);
        }
        updateAttemptsInfo(localAttempts);
        renderGrid();
      }
    };

    const falseStart = () => {
      if (attemptsLeft <= 0) {
        setStatus('No attempts left.');
        return;
      }
      clearTimeout(timeoutId);
      timeoutId = null;
      setState(State.FALSE);
      setStatus('False start! Tap to try again.');
      hintEl.textContent = 'You tapped before green.';
      timerEl.textContent = '—';
      beep(220, 180);
      shareBtn.disabled = true;
      lastReaction = null;
      tapLabel.textContent = 'Tap Here';
      registerAttempt('Foul');
    };

    const saveAttempt = async (reaction) => {
      if (!challengeId || !playerId) return;
      const attemptsRef = ref(db, `challenges/${challengeId}/players/${playerId}/attempts`);
      await runTransaction(attemptsRef, (attempts) => {
        const list = attempts || [];
        if (list.length >= 5) return list;
        list.push(reaction);
        return list;
      });
    };

    const record = () => {
      const reaction = Math.max(0, Math.round(performance.now() - startTime));
      lastReaction = reaction;
      if (bestReaction === null || reaction < bestReaction) {
        bestReaction = reaction;
      }
      timerEl.textContent = `${reaction} ms`;
      setState(State.RESULT);
      setStatus('Nice! Tap to play again.');
      hintEl.textContent = 'Try to beat your time.';
      beep(880, 100);
      shareBtn.disabled = false;
      registerAttempt(reaction);
      tapLabel.textContent = 'Tap Again';
    };

    const onTap = (event) => {
      if (state === State.WAITING) {
        falseStart();
        return;
      }
      if (state === State.GO) {
        record();
        return;
      }
      start();
    };

    const loadPlayerId = () => {
      const stored = localStorage.getItem('rtg-player-id');
      if (stored) return stored;
      const fresh = `player_${crypto.randomUUID()}`;
      localStorage.setItem('rtg-player-id', fresh);
      return fresh;
    };

    const updateAttemptsInfo = (count) => {
      attemptsLeft = Math.max(0, 5 - count);
      attemptsInfo.textContent = `Attempts left: ${attemptsLeft}`;
    };

    const normalizeAttempts = (attemptsRaw) => {
      if (!attemptsRaw) return [];
      if (Array.isArray(attemptsRaw)) return attemptsRaw;
      return Object.keys(attemptsRaw)
        .map((key) => Number(key))
        .filter((key) => Number.isFinite(key))
        .sort((a, b) => a - b)
        .map((key) => attemptsRaw[key]);
    };

    const renderGrid = () => {
      if (!challengeId) {
        gridEl.parentElement.hidden = false;
        const rows = [];
        rows.push('<div class="cell header">Player</div>');
        for (let i = 1; i <= 5; i += 1) {
          rows.push(`<div class="cell header">#${i}</div>`);
        }
        const soloBest = localAttemptValues
          .filter((value) => typeof value === 'number')
          .reduce((best, value) => (best === null || value < best ? value : best), null);
        rows.push('<div class="cell name">You</div>');
        for (let i = 0; i < 5; i += 1) {
          const value = localAttemptValues[i];
          if (value === undefined || value === null) {
            rows.push('<div class="cell">—</div>');
          } else if (value === 'Foul') {
            rows.push('<div class="cell">Foul</div>');
          } else {
            const isBest = soloBest !== null && value === soloBest;
            rows.push(`<div class="cell${isBest ? ' best' : ''}">${value} ms</div>`);
          }
        }
        gridEl.innerHTML = rows.join('');
        playerCountEl.textContent = 'Solo';
        winnerBanner.classList.remove('show');
        return;
      }

      const players = Object.values(currentPlayers);
      if (isJoined) {
        gridEl.parentElement.hidden = false;
      }
      playerCountEl.textContent = `${players.length} / 5`;
      const rows = [];
      rows.push('<div class="cell header">Player</div>');
      for (let i = 1; i <= 5; i += 1) {
        rows.push(`<div class="cell header">#${i}</div>`);
      }
      const playersWithBest = players.map((player) => {
        const attempts = normalizeAttempts(player?.attempts);
        const best = attempts
          .filter((value) => typeof value === 'number')
          .reduce((bestValue, value) => (bestValue === null || value < bestValue ? value : bestValue), null);
        return { player, attempts, best };
      });
      const challengeComplete = playersWithBest.length > 0 && playersWithBest.every(({ attempts }) => attempts.length >= 5);
      let winnerId = null;
      let winnerScore = null;
      if (challengeComplete) {
        playersWithBest.forEach(({ player, best }) => {
          if (best === null) return;
          if (winnerScore === null || best < winnerScore) {
            winnerScore = best;
            winnerId = player?.id;
          }
        });
      }
      if (players.length === 0) {
        rows.push('<div class="cell name" style="grid-column: 1 / -1;">No players yet. Join to start!</div>');
        gridEl.innerHTML = rows.join('');
        return;
      }

      playersWithBest.slice(0, 5).forEach(({ player, attempts, best }) => {
        const name = player?.name || 'Anonymous';
        rows.push(`<div class="cell name">${name}</div>`);
        for (let i = 0; i < 5; i += 1) {
          const value = attempts[i];
          if (value === undefined || value === null) {
            rows.push('<div class="cell">—</div>');
          } else if (value === 'Foul') {
            rows.push('<div class="cell">Foul</div>');
          } else {
            const isBest = best !== null && value === best;
            const isWinner = challengeComplete && player?.id === winnerId && isBest;
            rows.push(`<div class="cell${isBest ? ' best' : ''}${isWinner ? ' winner' : ''}">${value} ms</div>`);
          }
        }
      });
      gridEl.innerHTML = rows.join('');
      if (challengeComplete && winnerId) {
        const winnerName = playersWithBest.find(({ player }) => player?.id === winnerId)?.player?.name || 'Winner';
        winnerBanner.textContent = `Winner: ${winnerName} (${winnerScore} ms)`;
        winnerBanner.classList.add('show');
      } else {
        winnerBanner.classList.remove('show');
      }
    };

    const updateLinkUI = () => {
      if (!challengeId) {
        linkBox.textContent = 'Create a challenge to get a link.';
        copyBtn.disabled = true;
        challengeBtn.hidden = false;
        joinBtn.hidden = true;
        exitBtn.hidden = true;
        gridEl.parentElement.hidden = false;
        restartBtn.hidden = false;
        return;
      }
      const link = `${window.location.origin}${window.location.pathname}?challenge=${challengeId}`;
      linkBox.textContent = link;
      copyBtn.disabled = false;
      challengeBtn.hidden = true;
      joinBtn.hidden = isJoined;
      exitBtn.hidden = !isJoined;
      gridEl.parentElement.hidden = !isJoined;
      restartBtn.hidden = true;
    };

    const listenToChallenge = () => {
      if (!challengeId) return;
      const challengeRef = ref(db, `challenges/${challengeId}/players`);
      onValue(challengeRef, (snapshot) => {
        currentPlayers = snapshot.val() || {};
        Object.entries(currentPlayers).forEach(([id, player]) => {
          if (player && !player.id) {
            currentPlayers[id] = { ...player, id };
          }
        });
        renderGrid();
        const me = currentPlayers[playerId];
        if (me?.attempts) {
          updateAttemptsInfo(normalizeAttempts(me.attempts).length);
        }
        if (me && !isJoined) {
          isJoined = true;
          playerNameInput.value = me.name || '';
          setStatus('Welcome back! Tap the center box to start.');
          updateLinkUI();
        }
      });
    };

    const createChallenge = async () => {
      const newChallengeRef = push(ref(db, 'challenges'));
      challengeId = newChallengeRef.key;
      const now = Date.now();
      await set(newChallengeRef, {
        createdAt: now,
        maxPlayers: 5,
        maxAttempts: 5,
        players: {}
      });
      winnerBanner.classList.remove('show');
      isJoined = false;
      localAttempts = 0;
      updateAttemptsInfo(0);
      window.history.replaceState(null, '', `?challenge=${challengeId}`);
      updateLinkUI();
      listenToChallenge();
      setStatus('Challenge created! Add your name and join.');
    };

    const joinChallenge = async () => {
      playerName = playerNameInput.value.trim();
      if (!playerName) {
        setStatus('Add your name to join.');
        return;
      }
      if (!challengeId) {
        setStatus('Create a challenge first.');
        return;
      }

      const playersRef = ref(db, `challenges/${challengeId}/players`);
      const { committed } = await runTransaction(playersRef, (players) => {
        const current = players || {};
        if (current[playerId]) {
          current[playerId].name = playerName;
          return current;
        }
        if (Object.keys(current).length >= 5) {
          return;
        }
      current[playerId] = {
          id: playerId,
          name: playerName,
          joinedAt: Date.now(),
          attempts: []
        };
        return current;
      });

      if (!committed) {
        setStatus('Challenge is full.');
        return;
      }

      isJoined = true;
      setStatus('Joined! Tap the center box to start.');
      updateAttemptsInfo(0);
      listenToChallenge();
      updateLinkUI();
      reset();
    };

    const exitChallenge = async () => {
      if (!challengeId) return;
      isJoined = false;
      challengeId = null;
      window.history.replaceState(null, '', window.location.pathname);
      setStatus('Exited challenge. You can join again.');
      updateLinkUI();
      reset();
    };

    const hydrateFromUrl = async () => {
      playerId = loadPlayerId();
      const params = new URLSearchParams(window.location.search);
      const fromUrl = params.get('challenge');
      if (!fromUrl) {
        isJoined = true;
        localAttempts = 0;
        localAttemptValues = [];
        updateAttemptsInfo(0);
        setStatus('Solo mode. Tap the center box to start.');
        renderGrid();
        updateLinkUI();
        return;
      }
      challengeId = fromUrl;
      updateLinkUI();
      const snap = await get(ref(db, `challenges/${challengeId}`));
      if (!snap.exists()) {
        setStatus('Challenge not found.');
        challengeId = null;
        updateLinkUI();
        return;
      }
      winnerBanner.classList.remove('show');
      const players = snap.val()?.players || {};
      if (players[playerId]) {
        isJoined = true;
        playerNameInput.value = players[playerId].name || '';
        updateAttemptsInfo(players[playerId].attempts?.length || 0);
        updateLinkUI();
        setStatus('Welcome back! Tap the center box to start.');
      } else {
        isJoined = false;
        gridEl.parentElement.hidden = true;
      }
      listenToChallenge();
      if (!isJoined) {
        setStatus('Enter your name and join the challenge.');
      }
    };

    tapArea.addEventListener('pointerdown', onTap);
    tapArea.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' || event.key === ' ') {
        event.preventDefault();
        onTap(event);
      }
    });
    restartBtn.addEventListener('click', reset);
    soundBtn.addEventListener('click', () => {
      soundOn = !soundOn;
      soundBtn.textContent = `Sound: ${soundOn ? 'On' : 'Off'}`;
      soundBtn.setAttribute('aria-pressed', String(soundOn));
      if (soundOn) beep(620, 70);
    });
    shareBtn.addEventListener('click', () => {
      if (bestReaction === null) return;
      const link = window.location.href;
      const text = `My personal best is ${bestReaction} ms on this reaction time game! Can you beat it? ${link}`;
      const url = `https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(url, '_blank', 'noopener,noreferrer');
    });
    challengeBtn.addEventListener('click', createChallenge);
    joinBtn.addEventListener('click', joinChallenge);
    exitBtn.addEventListener('click', exitChallenge);
    copyBtn.addEventListener('click', async () => {
      if (!challengeId) return;
      const link = `${window.location.origin}${window.location.pathname}?challenge=${challengeId}`;
      await navigator.clipboard.writeText(link);
      setStatus('Challenge link copied!');
    });

    hydrateFromUrl();
    reset();
  </script>
</body>
</html>
